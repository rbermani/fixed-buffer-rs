# https://doc.rust-lang.org/cargo/guide/continuous-integration.html#gitlab-ci
# https://users.rust-lang.org/t/my-gitlab-config-docs-tests/16396/3
# https://docs.gitlab.com/ee/ci/yaml/

stages:
  - stage1

variables:
  CARGO_HOME: $CI_PROJECT_DIR/cargo

before_script:
  - rustc --version && cargo --version

after_script:
  - cd "$CI_PROJECT_DIR"
  - echo "Deleting cached files older than 90 days"
  - find target/ cargo/ -type f -mtime +90 -exec ls -alF {} \;
  - find target/ cargo/ -type f -mtime +90 -exec rm -vf {} \;

cache:
  when: always
  key: $CI_JOB_NAME
  paths:
    - target/
    - cargo/

rust-latest:
  stage: stage1
  image: rust:latest
  script:
    - ./check.sh

rust-beta:
  stage: stage1
  # Switch to official rust:beta image once it is available: https://github.com/rust-lang/docker-rust/issues/14
  image: instrumentisto/rust:beta
  script:
    - ./check.sh

rust-nightly:
  stage: stage1
  image: rustlang/rust:nightly
  script:
    - rustup component add rustfmt || cargo install --git https://github.com/rust-lang/rustfmt/ --force rustfmt-nightly
    - rustup component add clippy || cargo install --git https://github.com/rust-lang/rust-clippy/ --force clippy
    - ./check.sh
  allow_failure: true
